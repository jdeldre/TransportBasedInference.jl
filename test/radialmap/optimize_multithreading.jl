using Test

using LinearAlgebra, Statistics
using SpecialFunctions, ForwardDiff
using TransportMap


@testset "SparseKRmap Multi-threading test with optimization and evaluation of the resulting map" begin

   ensemble = EnsembleState(Matrix([6.831108232125667   6.831108465893829  10.748176564682273  17.220877261555913;
      7.341399771164814   7.341399033871628  11.440770534993137  18.015116463525178;
      6.877822405336048   6.877822863906546  10.793381797612751  17.379545045967195;
      6.971116690210811   6.971117274254750  10.941318835214862  17.571340756941474;
      7.800189373932513   7.800189247976281  11.929084958885008  18.852191934527564;
      6.706165535739543   6.706164938380805  10.596868885136731  17.100665224055952;
      7.162689725595848   7.162690676866085  11.236535720904731  17.691824497167673;
      7.700262639909202   7.700262776963255  11.870709137884843  18.589199307190668;
      6.941836510989174   6.941836045832242  10.822143995520504  17.705463568541791;
      7.284400905037024   7.284402833890172  11.438244192350945  17.713180862215779;
      6.114110264862537   6.114110399157427   9.744642327011279  16.427244631267527;
      6.884587321648968   6.884587349033709  10.880879551471059  17.360443337222691;
      6.964593674795581   6.964592742775720  11.015485574206627  17.379079978320874;
      7.174466645033212   7.174468203234895  11.165089908005559  17.802087293640490;
      7.625148752606352   7.625148374481078  11.784628799983244  18.470370177818385;
      7.878948627898106   7.878948112320454  12.118366730171301  18.770876038639738;
      7.406860218451342   7.406861450644357  11.470902695133232  18.293040279245396;
      7.308212626757207   7.308212927902813  11.381148951581917  17.962547003679237;
      7.519983057000856   7.519981781231936  11.597728250168640  18.407564589808729;
      7.813106349722561   7.813107415959238  11.973288464744240  18.802480702520111]'))


      order = [[-1], [1; 1], [-1; 1; 0], [-1; 1; 1; 0]]
      T       = SparseKRmap(4, order; λ = 0.0)
      Tserial = SparseKRmap(4, order; λ = 0.0)
      Tthread = SparseKRmap(4, order; λ = 0.0)

      # Run serial code
      @time run_optimization(T, ensemble; start = 2)


      # Run serial code
      @time run_optimization(Tserial, ensemble; start = 2, P = serial)

      # Run multi-threading code
      @show Threads.nthreads()
      @time run_optimization(Tthread, ensemble; start = 2, P = thread)

      @test norm(T(ensemble.S[:,1]) -     [6.831108232125667;
                                         0.07966241537360474;
                                        -0.18141931240603526;
                                         -2.0970508045942893])<1e-8

      @test norm(Tserial(ensemble.S[:,1]) -   [6.831108232125667;
                                             0.07966241537360474;
                                            -0.18141931240603526;
                                             -2.0970508045942893])<1e-8
      @test norm(Tthread(ensemble.S[:,1]) -   [6.831108232125667;
                                             0.07966241537360474;
                                            -0.18141931240603526;
                                             -2.0970508045942893])<1e-8
end
